<!--
 * Description:
 * Author:LinJ
 * Date:2021-11-05 00:46:18
 * LastEditors:LinJ
 * LastEditTime:2021-11-05 16:15:27
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Type Ahead ğŸ‘€</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <form class="search-form">
    <input type="text" class="search" placeholder="è¾“å…¥è¯—å¥ã€è¯—è¯æˆ–è¯—äºº">
    <ul class="suggestions">
      <li>è¿æ¥è¯—è¯åº“ä¸­....</li>
    </ul>
  </form>
<script>
const endpoint = 'https://gist.githubusercontent.com/soyaine/81399bb2b24ca1bb5313e1985533c640/raw/bdf7df2cbcf70706c4a5e51a7dfb8c933ed78878/TangPoetry.json';
let songList = [];
const input = document.querySelector('.search'),
      ul = document.querySelector('.suggestions');

async function getJson(url) {
  const response = await fetch(url);
  return await response.json();
}
function debounce (f, wait) {
  let timer
  return (...args) => {
    clearTimeout(timer)
    timer = setTimeout(() => {
      f(...args)
    }, wait)
  }
}
// æ£€ç´¢è¯—è¯ï¼Œç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„è¯—è¯å¹¶è¿”å›
function searchSongs (inputValue) {
  // ç­›é€‰è¯—è¯
  return songList.filter(song=>{
    return song.title.includes(inputValue) ||
    song.detail_author.includes(inputValue) ||
    song.detail_text.includes(inputValue);
  })
}

// å¯¹ä¼ å…¥çš„è¯—è¯ç»„è¿›è¡Œè§£æå¹¶æ¸²æŸ“
function renderList(matchList, highLishtStr){
  // å¯¹è¯—è¯è¿›è¡Œå¤„ç†
  let html = matchList.map(song => {
    let text = `<li><p>${song.detail_text}â€”â€”â€”â€”ã€Š${song.title}ã€‹${song.detail_author}<p></li>`;
    if(highLishtStr){
      // é«˜äº®æ˜¾ç¤º
      text = text.replace(new RegExp(highLishtStr, 'gi'),`<span class="hl">${highLishtStr}</span>`)
    }
    return text;
  }).join('');
  // æ¸²æŸ“
  ul.innerHTML = html;
}
// é˜²æŠ–ï¼Œæ¯æ¬¡ç»“æŸè¾“å…¥å500mså†…å¦‚æœæ²¡æœ‰ç»§ç»­è§¦å‘åˆ™æ‰§è¡Œæ“ä½œ
const inputChangeHandle = debounce(function (value){
  let matchedList = searchSongs(value);
  renderList(matchedList, value);
}, 500);

// function inputChangeHandle(e) {
//   let matchedList = searchSongs(this.value);
//   renderList(matchedList, this.value);
// }

// è·å–jsonæ•°æ®å¹¶è§£æ
getJson(endpoint)
  .then(data => {
    songList.push(...data);
    // è§£ææ•°æ®ï¼Œå°†æ ‡é¢˜ï¼Œä½œè€…å’Œå†…å®¹å•ç‹¬å–å‡º
    songList = songList.map(({title, detail_author, detail_text})=>{
      return { 
        title,
        detail_author: detail_author.join(','),
        detail_text 
      }
    });
    console.log('analyze completed')
    ul.innerHTML = `<li>è§£æå®Œæ¯•ï¼Œå¯ä»¥å¼€å§‹æ£€ç´¢</li>`
  })
// bind event
input.addEventListener('input',function (){
  inputChangeHandle(this.value);
})
</script>
</body>
</html>
